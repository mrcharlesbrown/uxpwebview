<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI WebView</title>
    <style>
        body { font-family: sans-serif; background-color: #282c34; color: white; padding: 15px; margin: 0; text-align: center; }
        #status { font-size: 1.2em; word-wrap: break-word; }
        .error { color: #ff9a9a; }
    </style>
</head>
<body>
    <div id="status">Waiting for prompt from Photoshop...</div>
    <script>
        const statusEl = document.getElementById('status');
        
        // IMPORTANT: This must match the ID in your manifest.json
        const PLUGIN_ID = "mcb-ps-geinie-plugin"; // "com.example.uxpwebviewai";
        const UXP_PLUGIN_ORIGIN = `uxp-plugin://${PLUGIN_ID}`;

        window.onmessage = async (event) => {
            // Security Check: Ensure the message is from the expected plugin origin
            if (event.origin !== UXP_PLUGIN_ORIGIN) {
                 statusEl.textContent = `Message rejected. Expected origin ${UXP_PLUGIN_ORIGIN} but got ${event.origin}.`;
                 statusEl.className = 'error';
                 return;
            }

            statusEl.textContent = "Origin check passed. Processing request...";
            statusEl.classList.remove('error');

            const { apiKey, prompt } = event.data;

            if (!apiKey || !prompt) {
                statusEl.textContent = 'Error: API Key or prompt was not received.';
                statusEl.className = 'error';
                return;
            }

            statusEl.textContent = "Contacting OpenAI API...";

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: 150
                    })
                });

                const responseText = await response.text(); // Get raw response text for better error logging
                if (!response.ok) {
                    // Try to parse error message from API, otherwise show raw text
                    let apiError = responseText;
                    try {
                        const errorJson = JSON.parse(responseText);
                        apiError = errorJson.error.message || responseText;
                    } catch (e) { /* ignore parsing error */ }
                    throw new Error(`API Error ${response.status}: ${apiError}`);
                }
                
                const data = JSON.parse(responseText);
                const result = data.choices[0].message.content;

                statusEl.innerHTML = `<strong>Success!</strong> Response received.`;
                
                // Send the result object back to the UXP plugin
                window.parent.postMessage(data, UXP_PLUGIN_ORIGIN);

            } catch (error) {
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.className = 'error';
                // Send the error details back to the plugin for logging
                window.parent.postMessage({ error: error.message }, UXP_PLUGIN_ORIGIN);
            }
        };
    </script>
</body>
</html>
