<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI WebView</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
        }
        .status.ready {
            background-color: #d4edda;
            color: #155724;
        }
        .status.processing {
            background-color: #fff3cd;
            color: #856404;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .api-selector {
            margin-bottom: 20px;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            width: 100%;
        }
        .response-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Integration Panel</h1>
        
        <div id="statusMessage" class="status ready">
            Ready to receive requests from Photoshop plugin
        </div>
        
        <div class="api-selector">
            <label for="aiProvider">AI Provider:</label>
            <select id="aiProvider">
                <option value="openai">OpenAI (GPT)</option>
                <option value="gemini">Google Gemini</option>
                <option value="stability">Stability AI</option>
            </select>
        </div>
        
        <div id="requestInfo" class="hidden">
            <h3>Last Request:</h3>
            <div id="promptDisplay"></div>
        </div>
        
        <div id="responseContainer">
            <h3>AI Response:</h3>
            <div id="responseArea" class="response-area">
                No response yet
            </div>
        </div>

		<!-- Add this to your ai-webview.html -->
		<div id="debugConsole" style="
			margin-top: 20px;
			padding: 10px;
			background: #f0f0f0;
			border: 1px solid #ddd;
			border-radius: 4px;
			max-height: 150px;
			overflow-y: auto;
			font-family: monospace;
			font-size: 12px;
		">
			<div>Debug Console:</div>
			<div id="debugLog"></div>
		</div>
    </div>

    <script>
        // Global variables to store the current request data
        let currentApiKey = '';
        let currentPrompt = '';
        
        // Update status message
        function updateStatus(message, type = 'ready') {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

		// Add this function to ai-webview.html
		function logDebug(message) {
			const debugLog = document.getElementById('debugLog');
			const entry = document.createElement('div');
			entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
			debugLog.appendChild(entry);
			debugLog.scrollTop = debugLog.scrollHeight;
		}

        // Handle messages from the Photoshop plugin
        window.addEventListener('message', async (event) => {
            logDebug(`Received message: ${JSON.stringify(event.data)}`);
            console.log("WebView received message:", event.data);

            // Verify the message structure
            if (event.data && event.data.type === 'ai-request') {
                console.log("Processing AI request with prompt:", event.data.prompt);

                currentApiKey = event.data.apiKey;
                currentPrompt = event.data.prompt;
                
                // Update UI
                document.getElementById('promptDisplay').textContent = currentPrompt;
                document.getElementById('requestInfo').classList.remove('hidden');
                updateStatus('Processing request...', 'processing');
                
                try {
                    const aiProvider = document.getElementById('aiProvider').value;
                    let response;
                    
                    switch (aiProvider) {
                        case 'openai':
                            response = await callOpenAI(currentPrompt, currentApiKey);
                            break;
                        case 'gemini':
                            response = await callGemini(currentPrompt, currentApiKey);
                            break;
                        case 'stability':
                            response = await callStabilityAI(currentPrompt, currentApiKey);
                            break;
                        default:
                            throw new Error('Unsupported AI provider');
                    }
                    
                    // Display the response
                    document.getElementById('responseArea').textContent = response;
                    updateStatus('Request completed successfully', 'ready');
                    
                    // Send response back to Photoshop plugin
                    window.parent.postMessage({
                        type: 'ai-response',
                        response: response
                    }, '*');
                    
                } catch (error) {
                        logDebug(`Full error: ${error.stack}`);
                    console.error('AI request failed:', error);
                    document.getElementById('responseArea').textContent = `Error: ${error.message}`;
                    updateStatus(`Error: ${error.message}`, 'error');
                    
                    // Send error back to Photoshop plugin
                    window.parent.postMessage({
                        type: 'ai-error',
                        error: error.message
                    }, '*');
                }
            }
        });
        
        // Function to call OpenAI API
        async function callOpenAI(prompt, apiKey) {
            try {
                  logDebug(`Starting OpenAI API call with prompt: ${prompt.substring(0, 50)}...`);
                  console.log("Initiating OpenAI API call with prompt:", prompt);
                  updateStatus('Calling OpenAI API...', 'processing');
                  
                  const endpoint = 'https://api.openai.com/v1/chat/completions';
                  const model = 'gpt-3.5-turbo'; // or 'gpt-4'

                  const controller = new AbortController();
                  const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                  
                  const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                              'Content-Type': 'application/json',
                              'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                              model: model,
                              messages: [
                                    {
                                    role: 'user',
                                    content: prompt
                                    }
                              ],
                              temperature: 0.7
                        }),
                        signal: controller.signal
                  });
                  
                  const endTime = Date.now();
                  logDebug(`API call completed in ${endTime - startTime}ms`);
                  
                  if (!response.ok) {
                        logDebug(`API error: ${response.status} ${response.statusText}`);
                  const errorData = await response.json();
                  throw new Error(errorData.error?.message || 'Failed to call OpenAI API');
                  }

                  clearTimeout(timeoutId);
                  const data = await response.json();
                  logDebug("Received API response");
                  return data.choices[0]?.message?.content || 'No response content';
            } catch (error) {
                  clearTimeout(timeoutId);
                  logDebug(`Request failed or timed out: ${error.message}`);
                  throw new Error(`Request timed out after 30 seconds: ${error.message}`);
            }
        }
        
        // Function to call Google Gemini API
        async function callGemini(prompt, apiKey) {
            updateStatus('Calling Google Gemini API...', 'processing');
            
            const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Failed to call Gemini API');
            }
            
            const data = await response.json();
            return data.candidates[0]?.content?.parts[0]?.text || 'No response content';
        }
        
        // Function to call Stability AI API
        async function callStabilityAI(prompt, apiKey) {
            updateStatus('Calling Stability AI API...', 'processing');
            
            const endpoint = 'https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image';
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`,
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    text_prompts: [{
                        text: prompt
                    }],
                    cfg_scale: 7,
                    height: 1024,
                    width: 1024,
                    steps: 30,
                    samples: 1
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to call Stability AI API');
            }
            
            const data = await response.json();
            
            // For Stability AI, we return the image URL (would need to upload to a hosting service)
            // In a real implementation, you might upload the image somewhere or handle it differently
            return `Image generation request successful. Artifact ID: ${data.artifacts[0]?.seed}`;
        }
        
        // Initialization
        updateStatus('Loaded and ready to receive requests', 'ready');
    </script>
</body>
</html>
